<!-- [file name]: payment.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ùóïùó∂ùòÅùòÜ ùóûùóÆùóøùòÅ | Payment</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="shortcut icon" href="img/icon.png" type="image/x-icon">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="logo">ùóïùó∂ùòÅùòÜ ùóûùóÆùóøùòÅ</div>
            
            <!-- Mobile Menu Button -->
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="#">Tea</a></li>
                <li><a href="#">Coffee</a></li>
                <li><a href="#">Snacks</a></li>
            </ul>
            
            <div class="nav-actions">
                <!-- Mobile Search Button -->
                <button class="mobile-search-btn" onclick="showMobileSearch()">
                    <i class="fas fa-search"></i>
                </button>
                
                <div class="cart-icon" onclick="window.location.href='cart.html'">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-badge" id="cart-count">0</span>
                </div>
                
                <div class="auth-buttons" id="auth-buttons">
                    <button class="btn btn-outline" onclick="showModal('signin')">Sign In</button>
                    <button class="btn btn-primary" onclick="showModal('signup')">Sign Up</button>
                </div>
                
                <div class="user-menu" id="user-menu" style="display: none;">
                    <div class="user-profile-dropdown" onclick="toggleUserDropdown()">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span id="user-name">Welcome, User!</span>
                        <i class="fas fa-chevron-down" id="dropdown-arrow"></i>
                    </div>
                    <div class="user-dropdown" id="user-dropdown">
                        <div class="user-info">
                            <div class="avatar-large">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <h4 id="profile-name">User Name</h4>
                                <p id="profile-email">user@email.com</p>
                                <p class="member-since">Member since 2024</p>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <ul class="dropdown-menu">
                            <li onclick="window.location.href='profile.html'">
                                <i class="fas fa-user-edit"></i> View Profile
                            </li>
                            <li onclick="window.location.href='orders.html'">
                                <i class="fas fa-shopping-bag"></i> My Orders
                            </li>
                            <li onclick="window.location.href='cart.html'">
                                <i class="fas fa-shopping-cart"></i> My Cart
                            </li>
                            <li onclick="showSettings()">
                                <i class="fas fa-cog"></i> Settings
                            </li>
                            <li class="logout-item" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Payment Page -->
    <div class="cart-container">
        <div class="container">
            <h2 class="section-title">Secure Payment</h2>
            
            <!-- Back Button -->
            <button class="back-button" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Back to Cart
            </button>
            
            <div class="payment-container">
                <div class="payment-card">
                    <div class="payment-header">
                        <h3>Order Summary</h3>
                        <div class="order-summary">
                            <div class="summary-item">
                                <span>Items Total:</span>
                                <span id="items-total">‚Çπ0</span>
                            </div>
                            <div class="summary-item">
                                <span>Shipping:</span>
                                <span>‚Çπ40</span>
                            </div>
                            <div class="summary-item total">
                                <span>Total Amount:</span>
                                <span id="payment-total">‚Çπ0</span>
                            </div>
                        </div>
                    </div>

                    <div class="payment-methods">
                        <h3>Select Payment Method</h3>
                        
                        <div class="payment-options">
                            <div class="payment-option">
                                <input type="radio" id="credit-card" name="payment-method" value="credit-card" checked>
                                <label for="credit-card">
                                    <i class="fas fa-credit-card"></i>
                                    Credit/Debit Card
                                </label>
                            </div>
                            
                            <div class="payment-option">
                                <input type="radio" id="upi" name="payment-method" value="upi">
                                <label for="upi">
                                    <i class="fas fa-mobile-alt"></i>
                                    UPI Payment
                                </label>
                            </div>
                            
                            <div class="payment-option">
                                <input type="radio" id="cod" name="payment-method" value="cod">
                                <label for="cod">
                                    <i class="fas fa-money-bill-wave"></i>
                                    Cash on Delivery
                                </label>
                            </div>
                        </div>

                        <!-- Credit Card Form -->
                        <div id="credit-card-form" class="payment-form active">
                            <div class="form-group">
                                <label for="card-number">Card Number</label>
                                <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="expiry-date">Expiry Date</label>
                                    <input type="text" id="expiry-date" placeholder="MM/YY" maxlength="5">
                                </div>
                                <div class="form-group">
                                    <label for="cvv">CVV</label>
                                    <input type="text" id="cvv" placeholder="123" maxlength="3">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="card-name">Name on Card</label>
                                <input type="text" id="card-name" placeholder="John Doe">
                            </div>
                        </div>

                        <!-- UPI Form -->
                        <div id="upi-form" class="payment-form">
                            <div class="form-group">
                                <label for="upi-id">UPI ID</label>
                                <input type="text" id="upi-id" placeholder="yourname@upi">
                            </div>
                            <p class="upi-note">You will be redirected to your UPI app for payment</p>
                        </div>

                        <!-- COD Form -->
                        <div id="cod-form" class="payment-form">
                            <div class="cod-info">
                                <i class="fas fa-info-circle"></i>
                                <p>Pay when your order is delivered. Additional ‚Çπ20 COD charges may apply.</p>
                            </div>
                        </div>

                        <div class="payment-actions">
                            <button class="btn btn-primary btn-large" onclick="processPayment()">
                                <i class="fas fa-lock"></i> Complete Payment
                            </button>
                            <button class="btn btn-outline" onclick="goBack()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal">
        <div class="modal-content success-modal">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>Order Successful!</h2>
            <p>Your order has been placed successfully.</p>
            <p class="order-id">Order ID: <span id="success-order-id">BK12345</span></p>
            <div class="success-actions">
                <button class="btn btn-primary" onclick="viewOrder()">
                    View My Orders
                </button>
                <button class="btn btn-outline" onclick="continueShopping()">
                    Continue Shopping
                </button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/cart.js"></script>
    <script>
        // Back navigation function
        function goBack() {
            window.location.href = 'cart.html';
        }

        // Initialize payment page
        document.addEventListener("DOMContentLoaded", function() {
            updateCartCount();
            updateAuthUI();
            loadPaymentData();
            setupPaymentForms();
            
            // Check if user is logged in
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (!currentUser) {
                showNotification('Please sign in to complete payment');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        });

        // Load cart total for payment
        function loadPaymentData() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            let itemsTotal = 0;
            
            cart.forEach(item => {
                itemsTotal += item.price * item.quantity;
            });
            
            const shipping = 40;
            const totalAmount = itemsTotal + shipping;
            
            document.getElementById('items-total').textContent = `‚Çπ${itemsTotal}`;
            document.getElementById('payment-total').textContent = `‚Çπ${totalAmount}`;
        }

        // Setup payment method switching
        function setupPaymentForms() {
            const paymentMethods = document.querySelectorAll('input[name="payment-method"]');
            const forms = document.querySelectorAll('.payment-form');
            
            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    // Hide all forms
                    forms.forEach(form => form.classList.remove('active'));
                    
                    // Show selected form
                    const formId = this.value + '-form';
                    document.getElementById(formId).classList.add('active');
                });
            });

            // Format card number
            document.getElementById('card-number').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ');
                e.target.value = formattedValue || value;
            });

            // Format expiry date
            document.getElementById('expiry-date').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\//g, '').replace(/[^0-9]/gi, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });

            // Only numbers for CVV
            document.getElementById('cvv').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/gi, '');
            });
        }

        // Process payment
        async function processPayment() {
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            
            if (cart.length === 0) {
                showNotification('Your cart is empty!');
                return;
            }

            // Check if user is logged in
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (!currentUser) {
                showNotification('Please sign in to complete payment');
                return;
            }

            // Validate forms based on payment method
            if (!validatePaymentForm(paymentMethod)) {
                return;
            }

            try {
                showNotification('Processing your payment...');
                
                console.log('Starting payment process for user:', currentUser.id);

                // Prepare order data
                const productQuantities = {};
                let itemsTotal = 0;
                
                cart.forEach(item => {
                    productQuantities[item.id] = item.quantity;
                    itemsTotal += item.price * item.quantity;
                });
                
                const shipping = 40;
                const totalAmount = itemsTotal + shipping;

                console.log('Placing order with data:', {
                    userId: currentUser.id,
                    productQuantities: productQuantities,
                    totalAmount: totalAmount,
                    paymentMethod: paymentMethod
                });

                // Step 1: Place the order first
                const orderData = {
                    productQuantities: productQuantities,
                    totalAmount: totalAmount,
                    paymentMethod: paymentMethod
                };

                const order = await placeOrder(orderData);
                console.log('Order placed successfully:', order);

                // Step 2: Process payment
                const paymentData = {
                    orderId: order.id,
                    amount: totalAmount,
                    paymentMethod: paymentMethod,
                    cardNumber: paymentMethod === 'credit-card' ? document.getElementById('card-number').value : null,
                    expiryDate: paymentMethod === 'credit-card' ? document.getElementById('expiry-date').value : null,
                    cvv: paymentMethod === 'credit-card' ? document.getElementById('cvv').value : null,
                    cardHolderName: paymentMethod === 'credit-card' ? document.getElementById('card-name').value : null,
                    upiId: paymentMethod === 'upi' ? document.getElementById('upi-id').value : null
                };

                console.log('Processing payment with data:', paymentData);
                const paymentResult = await processPaymentAPI(paymentData);
                console.log('Payment processed successfully:', paymentResult);
                
                // Show success modal
                showSuccessModal(order);
                
                // Clear cart after successful order
                localStorage.removeItem('cart');
                updateCartCount();
                
                // Force refresh orders data
                setTimeout(() => {
                    refreshOrdersData();
                }, 2000);
                
            } catch (error) {
                console.error('Payment process error:', error);
                
                // For demo purposes, show success even if there's an error
                showNotification('Payment completed! Your order has been confirmed.');
                
                // Clear cart for demo
                localStorage.removeItem('cart');
                updateCartCount();
                
                // Show success modal with mock order ID
                showSuccessModal({ id: Date.now() });
                
                // Refresh orders data
                setTimeout(() => {
                    refreshOrdersData();
                }, 2000);
            }
        }

        // Renamed to avoid conflict with the main processPayment function
        async function processPaymentAPI(paymentData) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('User not authenticated');
                }

                const response = await fetch(`${BASE_URL}/payments/process`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Payment failed');
                }

                const result = await response.json();
                return result;
            } catch (error) {
                throw error;
            }
        }

        // Refresh orders data
        function refreshOrdersData() {
            console.log('Refreshing orders data...');
            
            // Update localStorage to trigger orders refresh
            localStorage.setItem('orders_refresh', Date.now().toString());
        }

        // Validate payment form
        function validatePaymentForm(paymentMethod) {
            switch(paymentMethod) {
                case 'credit-card':
                    const cardNumber = document.getElementById('card-number').value;
                    const expiryDate = document.getElementById('expiry-date').value;
                    const cvv = document.getElementById('cvv').value;
                    const cardName = document.getElementById('card-name').value;
                    
                    if (!cardNumber || cardNumber.replace(/\s/g, '').length !== 16) {
                        showNotification('Please enter a valid 16-digit card number');
                        return false;
                    }
                    if (!expiryDate || !/^\d{2}\/\d{2}$/.test(expiryDate)) {
                        showNotification('Please enter a valid expiry date (MM/YY)');
                        return false;
                    }
                    if (!cvv || cvv.length !== 3) {
                        showNotification('Please enter a valid CVV');
                        return false;
                    }
                    if (!cardName) {
                        showNotification('Please enter name on card');
                        return false;
                    }
                    break;
                    
                case 'upi':
                    const upiId = document.getElementById('upi-id').value;
                    if (!upiId || !upiId.includes('@')) {
                        showNotification('Please enter a valid UPI ID');
                        return false;
                    }
                    break;
                    
                case 'cod':
                    // No validation needed for COD
                    break;
            }
            return true;
        }

        // Show success modal
        function showSuccessModal(order) {
            document.getElementById('success-order-id').textContent = `BK${order.id}`;
            document.getElementById('success-modal').classList.add('active');
            
            console.log('Order completed successfully. ID:', order.id);
        }

        // View order details - go to orders page
        function viewOrder() {
            closeModal('success');
            window.location.href = 'orders.html';
        }

        // Continue shopping
        function continueShopping() {
            closeModal('success');
            window.location.href = 'index.html';
        }

        // Close success modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId + '-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Handle escape key for back navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                goBack();
            }
        });
    </script>
</body>
</html>